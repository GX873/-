{"version":3,"file":"content.js","sources":["../src/content.ts"],"sourcesContent":["// 数据采集脚本\r\nclass DataCollector {\r\n  private static instance: DataCollector;\r\n  private observer: MutationObserver | null = null;\r\n  private retryCount = 0;\r\n  private readonly MAX_RETRIES = 3;\r\n\r\n  private constructor() {\r\n    this.initObserver();\r\n    // 添加页面卸载时的清理\r\n    window.addEventListener('unload', () => {\r\n      this.cleanup();\r\n    });\r\n  }\r\n\r\n  public static getInstance(): DataCollector {\r\n    if (!DataCollector.instance) {\r\n      DataCollector.instance = new DataCollector();\r\n    }\r\n    return DataCollector.instance;\r\n  }\r\n\r\n  private initObserver(): void {\r\n    try {\r\n      this.observer = new MutationObserver(() => {\r\n        this.collectData();\r\n      });\r\n\r\n      this.observer.observe(document.body, {\r\n        childList: true,\r\n        subtree: true\r\n      });\r\n    } catch (error) {\r\n      console.error('初始化观察器失败:', error);\r\n    }\r\n  }\r\n\r\n  private cleanup(): void {\r\n    if (this.observer) {\r\n      this.observer.disconnect();\r\n      this.observer = null;\r\n    }\r\n  }\r\n\r\n  private async collectData(): Promise<void> {\r\n    try {\r\n      const videoElements = document.querySelectorAll('.video-item');\r\n      const data = Array.from(videoElements).map(element => ({\r\n        id: element.getAttribute('data-id') || '',\r\n        title: element.querySelector('.title')?.textContent || '',\r\n        playCount: this.extractNumber(element.querySelector('.play-count')),\r\n        likeCount: this.extractNumber(element.querySelector('.like-count')),\r\n        commentCount: this.extractNumber(element.querySelector('.comment-count')),\r\n        shareCount: this.extractNumber(element.querySelector('.share-count')),\r\n        watchCompleteRate: this.extractNumber(element.querySelector('.complete-rate')),\r\n        publishTime: element.querySelector('.publish-time')?.getAttribute('datetime') || ''\r\n      }));\r\n\r\n      if (data.length > 0) {\r\n        await this.sendMessageWithRetry({\r\n          type: 'DATA_COLLECTED',\r\n          data\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('数据采集错误:', error);\r\n    }\r\n  }\r\n\r\n  private async sendMessageWithRetry(message: any): Promise<void> {\r\n    try {\r\n      await chrome.runtime.sendMessage(message);\r\n      this.retryCount = 0; // 重置重试计数\r\n    } catch (error) {\r\n      if (this.retryCount < this.MAX_RETRIES) {\r\n        this.retryCount++;\r\n        console.warn(`发送消息失败，正在重试 (${this.retryCount}/${this.MAX_RETRIES})`);\r\n        setTimeout(() => {\r\n          this.sendMessageWithRetry(message);\r\n        }, 1000 * this.retryCount); // 递增重试延迟\r\n      } else {\r\n        console.error('发送消息最终失败:', error);\r\n        this.retryCount = 0;\r\n      }\r\n    }\r\n  }\r\n\r\n  private extractNumber(element: Element | null): number {\r\n    if (!element) return 0;\r\n    const text = element.textContent || '';\r\n    return parseInt(text.replace(/[^0-9]/g, '')) || 0;\r\n  }\r\n\r\n  private async collectAccountData(): Promise<AccountAnalysis> {\r\n    try {\r\n      // 获取页面上的数据\r\n      const basicInfo = {\r\n        track: document.querySelector('.creator-info .track')?.textContent?.trim() || '',\r\n        nickname: document.querySelector('.creator-info .nickname')?.textContent?.trim() || '',\r\n        description: document.querySelector('.creator-info .description')?.textContent?.trim() || '',\r\n        homepage: window.location.href\r\n      };\r\n\r\n      const accountStats = {\r\n        likes: this.extractNumber(document.querySelector('.stats .likes-count')),\r\n        favorites: this.extractNumber(document.querySelector('.stats .favorites-count')),\r\n        followers: this.extractNumber(document.querySelector('.stats .followers-count')),\r\n        totalVideos: this.extractNumber(document.querySelector('.stats .videos-count')),\r\n        viralVideos: this.extractNumber(document.querySelector('.stats .viral-count')),\r\n        viralRate: this.extractNumber(document.querySelector('.stats .viral-rate'))\r\n      };\r\n\r\n      const accountPosition = {\r\n        positioning: document.querySelector('.position .type')?.textContent?.trim() || '',\r\n        persona: document.querySelector('.position .persona')?.textContent?.trim() || '',\r\n        audience: document.querySelector('.position .audience')?.textContent?.trim() || ''\r\n      };\r\n\r\n      const periodStats = {\r\n        days: 30, // 默认30天\r\n        publishedVideos: this.extractNumber(document.querySelector('.period-stats .published-count')),\r\n        totalInteractions: this.extractNumber(document.querySelector('.period-stats .interactions-count')),\r\n        viralVideosCount: this.extractNumber(document.querySelector('.period-stats .viral-count')),\r\n        recentViralRate: this.extractNumber(document.querySelector('.period-stats .viral-rate')),\r\n        viralVideoStats: {\r\n          likes: this.extractNumber(document.querySelector('.viral-stats .likes-count')),\r\n          favorites: this.extractNumber(document.querySelector('.viral-stats .favorites-count')),\r\n          comments: this.extractNumber(document.querySelector('.viral-stats .comments-count'))\r\n        }\r\n      };\r\n\r\n      return {\r\n        basicInfo,\r\n        accountStats,\r\n        accountPosition,\r\n        periodStats\r\n      };\r\n    } catch (error) {\r\n      console.error('采集账号数据失败:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\n// 初始化数据采集器\r\nDataCollector.getInstance(); "],"names":["_DataCollector","__publicField","error","videoElements","data","element","_a","_b","message","text","_c","_d","_e","_f","_g","_h","_i","_j","_k","_l","basicInfo","accountStats","accountPosition","periodStats","DataCollector"],"mappings":"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"}